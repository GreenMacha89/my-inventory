<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Personal Inventory</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#0f0e0c;--surface:#1a1915;--surface2:#242320;--border:#2e2d29;
      --accent:#e8c76d;--text:#f0ece3;--text-muted:#7a7567;--text-dim:#4a4840;
      --film:#6d8fe8;--book:#6dc98a;--doc:#c96d9a;--item:#e8896d;--bin:#e86d6d;
      --radius:12px;--tr:0.2s ease;
    }
    html{scroll-behavior:smooth}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6}
    body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:0;opacity:.4}
    header{position:sticky;top:0;z-index:100;background:rgba(15,14,12,.92);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);padding:0 clamp(16px,4vw,48px)}
    .hi{max-width:1400px;margin:0 auto;display:flex;align-items:center;gap:10px;height:64px}
    .logo{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:900;letter-spacing:-.02em;color:var(--accent);white-space:nowrap;flex-shrink:0}
    .logo span{color:var(--text-muted);font-weight:400}
    .sw{flex:1;position:relative;max-width:420px}
    .sw svg{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text-muted);pointer-events:none}
    #searchInput{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:50px;padding:9px 16px 9px 42px;color:var(--text);font-family:inherit;font-size:.9rem;outline:none;transition:border-color var(--tr),box-shadow var(--tr)}
    #searchInput::placeholder{color:var(--text-dim)}
    #searchInput:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(232,199,109,.12)}
    .btn-add{margin-left:auto;background:var(--accent);color:#0f0e0c;border:none;border-radius:50px;padding:9px 20px;font-family:inherit;font-weight:500;font-size:.88rem;cursor:pointer;display:flex;align-items:center;gap:7px;white-space:nowrap;transition:transform var(--tr),background var(--tr);flex-shrink:0}
    .btn-add:hover{transform:translateY(-1px);background:#f0d47a}
    .btn-io{background:transparent;border:1px solid var(--border);border-radius:50px;padding:8px 14px;font-family:inherit;font-weight:500;font-size:.82rem;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;gap:6px;white-space:nowrap;transition:all var(--tr);flex-shrink:0}
    .btn-io:hover{border-color:var(--accent);color:var(--accent);background:rgba(232,199,109,.06)}
    .btn-io.bin-btn:hover,.btn-io.bin-btn.active{border-color:var(--bin);color:var(--bin);background:rgba(232,109,109,.08)}
    .export-wrap{position:relative;flex-shrink:0}
    .export-menu{position:absolute;top:calc(100% + 8px);right:0;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:6px;min-width:165px;display:none;flex-direction:column;gap:2px;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:50}
    .export-wrap.open .export-menu{display:flex}
    .export-opt{background:transparent;border:none;border-radius:7px;padding:8px 12px;color:var(--text-muted);font-family:inherit;font-size:.85rem;cursor:pointer;text-align:left;display:flex;align-items:center;gap:8px;transition:background var(--tr),color var(--tr)}
    .export-opt:hover{background:var(--surface2);color:var(--text)}
    .sync-dot{width:8px;height:8px;border-radius:50%;background:var(--text-dim);flex-shrink:0;transition:background .4s}
    .sync-dot.syncing{background:var(--accent);animation:pulse 1s infinite}
    .sync-dot.ok{background:#6dc98a}
    .sync-dot.error{background:#e86d6d}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
    .toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(12px);background:var(--surface2);border:1px solid var(--border);border-radius:50px;padding:10px 22px;font-size:.85rem;color:var(--text);opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;z-index:300;white-space:nowrap}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .container{max-width:1400px;margin:0 auto;padding:clamp(16px,3vw,40px) clamp(16px,4vw,48px);position:relative;z-index:1}
    .bin-banner{display:none;align-items:center;gap:12px;background:rgba(232,109,109,.08);border:1px solid rgba(232,109,109,.25);border-radius:10px;padding:12px 18px;margin-bottom:20px;font-size:.88rem;color:var(--bin)}
    .bin-banner.visible{display:flex}
    .bin-empty-btn{margin-left:auto;background:transparent;border:1px solid var(--bin);border-radius:6px;padding:4px 12px;color:var(--bin);font-family:inherit;font-size:.8rem;cursor:pointer;transition:all var(--tr)}
    .bin-empty-btn:hover{background:var(--bin);color:#fff}
    .stats-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:24px}
    .stat-pill{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:50px;padding:6px 14px 6px 10px;font-size:.83rem;cursor:pointer;transition:border-color var(--tr),background var(--tr);user-select:none}
    .stat-pill:hover,.stat-pill.active{border-color:var(--pill-color,var(--accent));background:var(--surface2)}
    .stat-pill.active{box-shadow:0 0 0 2px color-mix(in srgb,var(--pill-color,var(--accent)) 25%,transparent)}
    .sdot{width:8px;height:8px;border-radius:50%;background:var(--pill-color,var(--accent));flex-shrink:0}
    .scount{background:var(--surface2);border-radius:50px;padding:1px 8px;font-size:.73rem;color:var(--text-muted);margin-left:2px}
    .sort-bar{display:flex;align-items:center;gap:10px;margin-bottom:18px;flex-wrap:wrap}
    .sort-label{font-size:.8rem;color:var(--text-muted)}
    .sort-btn{background:transparent;border:1px solid var(--border);border-radius:6px;padding:4px 12px;color:var(--text-muted);font-family:inherit;font-size:.8rem;cursor:pointer;transition:all var(--tr)}
    .sort-btn.active,.sort-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(232,199,109,.06)}
    .rcount{margin-left:auto;font-size:.8rem;color:var(--text-dim)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:14px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;transition:transform var(--tr),border-color var(--tr),box-shadow var(--tr);animation:fadeUp .3s ease both}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .card:hover{transform:translateY(-3px);border-color:var(--card-color,var(--accent));box-shadow:0 8px 28px rgba(0,0,0,.4)}
    .card.bin-card{opacity:.78}
    .ct{height:130px;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:2.8rem;position:relative}
    .cc{position:absolute;top:10px;right:10px;background:rgba(15,14,12,.85);border:1px solid var(--card-color,var(--accent));color:var(--card-color,var(--accent));border-radius:50px;padding:2px 10px;font-size:.68rem;font-weight:500;letter-spacing:.04em;text-transform:uppercase}
    .cb{padding:12px 14px;flex:1;display:flex;flex-direction:column;gap:5px}
    .ctitle{font-family:'Playfair Display',serif;font-size:.97rem;font-weight:700;line-height:1.3}
    .cmeta{font-size:.78rem;color:var(--text-muted);display:flex;flex-wrap:wrap;gap:5px}
    .cmeta span{display:flex;align-items:center;gap:3px}
    .cnotes{font-size:.78rem;color:var(--text-dim);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .sbadge{display:inline-flex;align-items:center;border-radius:50px;padding:2px 10px;font-size:.7rem;font-weight:500;border:1px solid}
    .cf{padding:9px 14px;border-top:1px solid var(--border);display:flex;gap:7px;align-items:center}
    .cfa{margin-left:auto;display:flex;gap:5px}
    .dtag{font-size:.68rem;color:var(--bin);background:rgba(232,109,109,.1);border:1px solid rgba(232,109,109,.2);border-radius:50px;padding:2px 8px}
    .ib{background:transparent;border:1px solid var(--border);border-radius:6px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-muted);text-decoration:none;transition:all var(--tr)}
    .ib:hover{border-color:var(--accent);color:var(--accent);background:rgba(232,199,109,.08)}
    .ib.del:hover{border-color:#e86d6d;color:#e86d6d;background:rgba(232,109,109,.08)}
    .ib.res:hover{border-color:#6dc98a;color:#6dc98a;background:rgba(109,201,138,.08)}
    .empty{grid-column:1/-1;text-align:center;padding:72px 20px;color:var(--text-dim)}
    .empty-icon{font-size:3rem;margin-bottom:14px;opacity:.4}
    .empty h3{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--text-muted);margin-bottom:6px}
    .loading{grid-column:1/-1;text-align:center;padding:72px 20px;color:var(--text-muted)}
    .spinner{width:30px;height:30px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 14px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .modal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .25s}
    .modal-overlay.open{opacity:1;pointer-events:all}
    .modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;transform:translateY(20px);transition:transform .25s}
    .modal-overlay.open .modal{transform:translateY(0)}
    .mh{padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .mt{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:700}
    .mc{background:transparent;border:none;color:var(--text-muted);cursor:pointer;font-size:1.3rem;line-height:1;transition:color var(--tr)}
    .mc:hover{color:var(--text)}
    .mb{padding:18px 22px;display:flex;flex-direction:column;gap:14px}
    label{font-size:.82rem;color:var(--text-muted);display:block;margin-bottom:4px}
    input[type="text"],input[type="number"],select,textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 13px;color:var(--text);font-family:inherit;font-size:.88rem;outline:none;transition:border-color var(--tr),box-shadow var(--tr)}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(232,199,109,.1)}
    textarea{resize:vertical;min-height:66px}
    select option{background:var(--surface2)}
    .fr{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .ctabs{display:flex;gap:7px;flex-wrap:wrap}
    .ctab{border:1px solid var(--border);border-radius:8px;padding:7px 13px;cursor:pointer;font-size:.83rem;transition:all var(--tr);background:transparent;color:var(--text-muted);font-family:inherit;display:flex;align-items:center;gap:5px}
    .ctab.sel{border-color:var(--tc);background:color-mix(in srgb,var(--tc) 12%,transparent);color:var(--tc)}
    .mf{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:9px;justify-content:flex-end}
    .btn{border:none;border-radius:8px;padding:9px 18px;font-family:inherit;font-size:.88rem;font-weight:500;cursor:pointer;transition:all var(--tr)}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text-muted)}
    .btn-ghost:hover{border-color:var(--text-muted);color:var(--text)}
    .btn-primary{background:var(--accent);color:#0f0e0c}
    .btn-primary:hover:not(:disabled){background:#f0d47a;transform:translateY(-1px)}
    ::-webkit-scrollbar{width:5px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
    @media(max-width:640px){.fr{grid-template-columns:1fr}.logo span{display:none}.lbl{display:none}}
  </style>
</head>
<body>
<header>
  <div class="hi">
    <div class="logo">Vault <span>/ My Inventory</span></div>
    <div class="sw">
      <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input id="searchInput" type="text" placeholder="Search your collectionâ€¦"/>
    </div>
    <div class="sync-dot" id="syncDot" title="Sync status"></div>

    <!-- Export dropdown -->
    <div class="export-wrap" id="exportWrap">
      <button class="btn-io" onclick="toggleExport(event)">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <span class="lbl">Export</span>
        <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
      </button>
      <div class="export-menu" id="exportMenu">
        <button class="export-opt" onclick="exportJSON()">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Backup (.json)
        </button>
        <button class="export-opt" onclick="exportExcel()">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
          Excel (.xlsx)
        </button>
      </div>
    </div>

    <!-- Bin button -->
    <button class="btn-io bin-btn" id="binToggle" onclick="toggleBin()">
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
      <span class="lbl">Bin</span>
      <span id="binBadge" style="display:none;background:var(--bin);color:#fff;border-radius:50px;padding:1px 7px;font-size:.72rem;margin-left:2px"></span>
    </button>

    <button class="btn-add" onclick="openModal()">
      <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
      Add Item
    </button>
  </div>
</header>

<div class="toast" id="toast"></div>

<div class="container">
  <div class="bin-banner" id="binBanner">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>
    Showing deleted items â€” you can restore or permanently delete them.
    <button class="bin-empty-btn" onclick="emptyBin()">Empty Bin</button>
  </div>
  <div class="stats-bar" id="statsBar"></div>
  <div class="sort-bar">
    <span class="sort-label">Sort:</span>
    <button class="sort-btn active" data-sort="date">Recent</button>
    <button class="sort-btn" data-sort="title">Aâ€“Z</button>
    <span class="rcount" id="rcount"></span>
  </div>
  <div class="grid" id="grid">
    <div class="loading"><div class="spinner"></div>Connecting to your vaultâ€¦</div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="overlayClick(event)">
  <div class="modal">
    <div class="mh">
      <div class="mt" id="modalTitle">Add New Item</div>
      <button class="mc" onclick="closeModal()">&#x2715;</button>
    </div>
    <div class="mb">
      <div>
        <label>Category</label>
        <div class="ctabs">
          <button class="ctab" data-cat="film" style="--tc:var(--film)" onclick="selCat('film')">&#x1F3AC; Film / TV</button>
          <button class="ctab" data-cat="book" style="--tc:var(--book)" onclick="selCat('book')">&#x1F4DA; Book</button>
          <button class="ctab" data-cat="doc"  style="--tc:var(--doc)"  onclick="selCat('doc')">&#x1F4C4; Document</button>
          <button class="ctab" data-cat="item" style="--tc:var(--item)" onclick="selCat('item')">&#x1F4E6; Item</button>
        </div>
      </div>
      <div><label>Title *</label><input type="text" id="fTitle" placeholder="e.g. The Godfather, Dune, Invoice 2024â€¦"/></div>
      <div><label id="creatorLbl">Author / Director</label><input type="text" id="fCreator" placeholder="e.g. Francis Ford Coppola"/></div>
      <div class="fr">
        <div><label>Year</label><input type="number" id="fYear" placeholder="e.g. 1972" min="1800" max="2100"/></div>
        <div>
          <label>Status</label>
          <select id="fStatus">
            <option value="">â€” select â€”</option>
            <option>Watched</option><option>Want to watch</option><option>Watching</option>
            <option>Read</option><option>Reading</option><option>Want to read</option>
            <option>Owned</option><option>Lent out</option><option>Archived</option><option>Other</option>
          </select>
        </div>
      </div>
      <div><label>Genre / Tags</label><input type="text" id="fTags" placeholder="e.g. Thriller, Sci-fi"/></div>
      <div><label>URL</label><input type="text" id="fURL" placeholder="e.g. https://www.imdb.com/title/â€¦"/></div>
      <div id="fldProducer" style="display:none"><label>Producer</label><input type="text" id="fProducer" placeholder="e.g. Steven Spielberg"/></div>
      <div id="fldBook" style="display:none">
        <div class="fr">
          <div><label>Publisher</label><input type="text" id="fPublisher" placeholder="e.g. Penguin Books"/></div>
          <div><label>ISBN</label><input type="text" id="fISBN" placeholder="e.g. 978-0-00-000000-0"/></div>
        </div>
      </div>
      <div><label>Notes</label><textarea id="fNotes" placeholder="Any extra details, thoughts, locationâ€¦"></textarea></div>
    </div>
    <div class="mf">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="saveBtn" onclick="saveItem()">Save Item</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ SUPABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var SUPA_URL = 'https://jikhpewxfwwaqjnylvjv.supabase.co';
var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imppa2hwZXd4Znd3YXFqbnlsdmp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTI0MTAsImV4cCI6MjA4NjcyODQxMH0.Z1m_v9I-iGLaGhSgTo89INFVHDw1MaQLigwab0K0Fq0';
var db = supabase.createClient(SUPA_URL, SUPA_KEY);

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var items = [], binItems = [];
var showBin = false, editingId = null, curCat = 'film';
var activeFilter = 'all', activeSort = 'date';
var binMigrated = false; // tracks whether deleted columns exist

var CAT = {
  film:{label:'Film/TV', color:'var(--film)', emoji:'ğŸ¬'},
  book:{label:'Book',    color:'var(--book)', emoji:'ğŸ“š'},
  doc: {label:'Document',color:'var(--doc)',  emoji:'ğŸ“„'},
  item:{label:'Item',    color:'var(--item)', emoji:'ğŸ“¦'}
};
var SC = {
  'Watched':'#6d8fe8','Read':'#6dc98a','Owned':'#e8c76d',
  'Want to watch':'#a0a0a0','Want to read':'#a0a0a0',
  'Watching':'#c97d4e','Reading':'#c97d4e',
  'Lent out':'#c96d9a','Archived':'#4a4840','Other':'#7a7567'
};

// â”€â”€ SYNC DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setDot(s) {
  var d = document.getElementById('syncDot');
  d.className = 'sync-dot ' + s;
  d.title = {syncing:'Savingâ€¦', ok:'All changes saved', error:'Connection error'}[s] || '';
}

// â”€â”€ LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadItems() {
  setDot('syncing');
  // First try with deleted column filter
  var res = await db.from('items').select('*').eq('deleted', false).order('created_at', {ascending:false});
  if (res.error) {
    // Column doesn't exist yet â€” load all without filter
    var res2 = await db.from('items').select('*').order('created_at', {ascending:false});
    if (res2.error) {
      setDot('error');
      toast('Connection error: ' + res2.error.message);
      document.getElementById('grid').innerHTML = '<div class="empty"><div class="empty-icon">âš ï¸</div><h3>Connection error</h3><p>' + esc(res2.error.message) + '</p></div>';
      return;
    }
    items = res2.data || [];
    binItems = [];
    binMigrated = false;
    setDot('ok');
    updateBinBadge();
    render();
    return;
  }
  binMigrated = true;
  var binRes = await db.from('items').select('*').eq('deleted', true).order('deleted_at', {ascending:false});
  items    = res.data || [];
  binItems = (binRes.data) || [];
  setDot('ok');
  updateBinBadge();
  render();
}

// â”€â”€ CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function dbInsert(payload) {
  setDot('syncing');
  var p = Object.assign({}, payload);
  if (binMigrated) p.deleted = false;
  var r = await db.from('items').insert([p]).select().single();
  if (r.error) { setDot('error'); toast('Save failed: ' + r.error.message); return null; }
  setDot('ok'); return r.data;
}
async function dbUpdate(id, payload) {
  setDot('syncing');
  var r = await db.from('items').update(payload).eq('id', id);
  if (r.error) { setDot('error'); toast('Update failed: ' + r.error.message); return false; }
  setDot('ok'); return true;
}
async function dbSoftDelete(id) {
  setDot('syncing');
  var r = await db.from('items').update({deleted:true, deleted_at: new Date().toISOString()}).eq('id', id);
  if (r.error) { setDot('error'); toast('Error: ' + r.error.message); return false; }
  setDot('ok'); return true;
}
async function dbRestore(id) {
  setDot('syncing');
  var r = await db.from('items').update({deleted:false, deleted_at:null}).eq('id', id);
  if (r.error) { setDot('error'); toast('Error: ' + r.error.message); return false; }
  setDot('ok'); return true;
}
async function dbHardDelete(id) {
  setDot('syncing');
  var r = await db.from('items').delete().eq('id', id);
  if (r.error) { setDot('error'); toast('Error: ' + r.error.message); return false; }
  setDot('ok'); return true;
}

// â”€â”€ REALTIME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.channel('vault-rt').on('postgres_changes',{event:'*',schema:'public',table:'items'},loadItems).subscribe();

// â”€â”€ BIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateBinBadge() {
  var b = document.getElementById('binBadge');
  if (binItems.length) { b.textContent = binItems.length; b.style.display = ''; }
  else b.style.display = 'none';
}
function toggleBin() {
  showBin = !showBin;
  activeFilter = 'all';
  document.getElementById('binToggle').classList.toggle('active', showBin);
  document.getElementById('binBanner').classList.toggle('visible', showBin);
  render();
}
async function emptyBin() {
  if (!binItems.length) return;
  if (!confirm('Permanently delete all ' + binItems.length + ' item(s)? This cannot be undone.')) return;
  setDot('syncing');
  var r = await db.from('items').delete().eq('deleted', true);
  if (r.error) { setDot('error'); toast('Error: ' + r.error.message); return; }
  setDot('ok'); toast('Bin emptied.'); await loadItems();
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() { renderStats(); renderGrid(); }

function renderStats() {
  var src = showBin ? binItems : items;
  var counts = {film:0,book:0,doc:0,item:0};
  src.forEach(function(i){ if(counts[i.cat]!==undefined) counts[i.cat]++; });
  var h = '<div class="stat-pill '+(activeFilter==='all'?'active':'')+'" style="--pill-color:var(--accent)" onclick="setFilter(\'all\')"><div class="sdot"></div> All <span class="scount">'+src.length+'</span></div>';
  Object.keys(CAT).forEach(function(k){
    var v = CAT[k];
    h += '<div class="stat-pill '+(activeFilter===k?'active':'')+'" style="--pill-color:'+v.color+'" onclick="setFilter(\''+k+'\')"><div class="sdot" style="background:'+v.color+'"></div> '+v.label+' <span class="scount">'+(counts[k]||0)+'</span></div>';
  });
  document.getElementById('statsBar').innerHTML = h;
}

function renderGrid() {
  var src = showBin ? binItems : items;
  var q = document.getElementById('searchInput').value.toLowerCase();
  var list = src.filter(function(i){
    var mc = activeFilter==='all' || i.cat===activeFilter;
    var mq = !q || (i.title||'').toLowerCase().includes(q) || (i.creator||'').toLowerCase().includes(q) || (i.tags||'').toLowerCase().includes(q) || (i.notes||'').toLowerCase().includes(q);
    return mc && mq;
  });
  if (activeSort==='title') list.sort(function(a,b){ return (a.title||'').localeCompare(b.title||''); });
  document.getElementById('rcount').textContent = list.length===src.length ? src.length+' items' : list.length+' of '+src.length;
  var grid = document.getElementById('grid');
  if (!list.length) {
    var ei = showBin ? {ic:'ğŸ—‘',h:'Bin is empty',p:'Deleted items will appear here.'} : items.length ? {ic:'ğŸ”',h:'No results found',p:'Try a different search or filter.'} : {ic:'ğŸ“­',h:'Your vault is empty',p:'Click "+ Add Item" to start your collection!'};
    grid.innerHTML = '<div class="empty"><div class="empty-icon">'+ei.ic+'</div><h3>'+ei.h+'</h3><p>'+ei.p+'</p></div>';
    return;
  }
  grid.innerHTML = list.map(function(item){
    var meta = CAT[item.cat] || CAT.item;
    var sc   = SC[item.status] || 'var(--text-muted)';
    var clr  = showBin ? 'var(--bin)' : meta.color;
    var ddate = item.deleted_at ? new Date(item.deleted_at).toLocaleDateString() : '';
    var actions = showBin
      ? '<button class="ib res" title="Restore" onclick="doRestore(\''+item.id+'\')"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.5"/></svg></button><button class="ib del" title="Delete permanently" onclick="doHard(\''+item.id+'\')"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button>'
      : (item.url ? '<a class="ib" href="'+esc(item.url)+'" target="_blank" rel="noopener" title="Open URL"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a>' : '')
        + '<button class="ib" title="Edit" onclick="editItem(\''+item.id+'\')"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>'
        + '<button class="ib del" title="Move to Bin" onclick="doSoft(\''+item.id+'\')"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button>';
    var footer = showBin
      ? '<span class="dtag">Deleted '+ddate+'</span>'
      : (item.status ? '<span class="sbadge" style="color:'+sc+';border-color:'+sc+';background:'+sc+'18">'+esc(item.status)+'</span>' : '<span></span>');
    return '<div class="card'+(showBin?' bin-card':'')+'" style="--card-color:'+clr+'"><div class="ct"><span>'+meta.emoji+'</span><div class="cc" style="border-color:'+clr+';color:'+clr+'">'+meta.label+'</div></div><div class="cb"><div class="ctitle">'+esc(item.title)+'</div><div class="cmeta">'
      +(item.creator   ? '<span>âœ¦ '+esc(item.creator)+'</span>' : '')
      +(item.producer  ? '<span>ğŸ¥ '+esc(item.producer)+'</span>' : '')
      +(item.publisher ? '<span>ğŸ¢ '+esc(item.publisher)+'</span>' : '')
      +(item.isbn      ? '<span>ISBN: '+esc(item.isbn)+'</span>' : '')
      +(item.year      ? '<span>ğŸ“… '+esc(item.year)+'</span>' : '')
      +(item.tags      ? '<span>ğŸ· '+esc(item.tags)+'</span>' : '')
      +'</div>'+(item.notes ? '<div class="cnotes">'+esc(item.notes)+'</div>' : '')+'</div><div class="cf">'+footer+'<div class="cfa">'+actions+'</div></div></div>';
  }).join('');
}

function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// â”€â”€ FILTER/SORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(f){ activeFilter=f; render(); }
document.querySelectorAll('.sort-btn').forEach(function(b){
  b.addEventListener('click',function(){
    document.querySelectorAll('.sort-btn').forEach(function(x){ x.classList.remove('active'); });
    b.classList.add('active'); activeSort=b.dataset.sort; renderGrid();
  });
});
document.getElementById('searchInput').addEventListener('input', renderGrid);

// close export menu on outside click
document.addEventListener('click',function(e){
  var w = document.getElementById('exportWrap');
  if (!w.contains(e.target)) w.classList.remove('open');
});
function toggleExport(e){ e.stopPropagation(); document.getElementById('exportWrap').classList.toggle('open'); }

// â”€â”€ ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doSoft(id){
  if (!binMigrated){ alert('Please run the SQL migration in Supabase first to enable the Bin.\n\nSQL:\nALTER TABLE items ADD COLUMN IF NOT EXISTS deleted boolean DEFAULT false;\nALTER TABLE items ADD COLUMN IF NOT EXISTS deleted_at timestamptz;'); return; }
  if (!confirm('Move this item to the Bin?')) return;
  var ok = await dbSoftDelete(id);
  if (ok){ toast('Moved to Bin.'); await loadItems(); }
}
async function doRestore(id){ var ok = await dbRestore(id); if(ok){ toast('Item restored!'); await loadItems(); } }
async function doHard(id){ if (!confirm('Permanently delete? This cannot be undone.')) return; var ok = await dbHardDelete(id); if(ok){ toast('Permanently deleted.'); await loadItems(); } }

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(){
  editingId=null;
  document.getElementById('modalTitle').textContent='Add New Item';
  ['fTitle','fCreator','fYear','fStatus','fTags','fURL','fNotes','fProducer','fPublisher','fISBN'].forEach(function(id){ var el=document.getElementById(id); if(el) el.value=''; });
  selCat('film');
  document.getElementById('modalOverlay').classList.add('open');
  setTimeout(function(){ document.getElementById('fTitle').focus(); },100);
}
function closeModal(){ document.getElementById('modalOverlay').classList.remove('open'); }
function overlayClick(e){ if(e.target.id==='modalOverlay') closeModal(); }

function selCat(cat){
  curCat=cat;
  document.querySelectorAll('.ctab').forEach(function(t){ t.classList.remove('sel'); });
  document.querySelector('.ctab[data-cat="'+cat+'"]').classList.add('sel');
  var lbls={film:'Director / Creator',book:'Author',doc:'Author / Source',item:'Brand / Maker'};
  document.getElementById('creatorLbl').textContent=lbls[cat]||'Creator';
  document.getElementById('fldProducer').style.display=cat==='film'?'':'none';
  document.getElementById('fldBook').style.display=cat==='book'?'':'none';
}

function getPayload(){
  return {
    cat:curCat,
    title:    document.getElementById('fTitle').value.trim(),
    creator:  document.getElementById('fCreator').value.trim(),
    year:     document.getElementById('fYear').value.trim(),
    status:   document.getElementById('fStatus').value,
    tags:     document.getElementById('fTags').value.trim(),
    notes:    document.getElementById('fNotes').value.trim(),
    url:      document.getElementById('fURL').value.trim(),
    producer: curCat==='film' ? document.getElementById('fProducer').value.trim() : '',
    publisher:curCat==='book' ? document.getElementById('fPublisher').value.trim() : '',
    isbn:     curCat==='book' ? document.getElementById('fISBN').value.trim() : ''
  };
}

async function saveItem(){
  var p = getPayload();
  if (!p.title){ document.getElementById('fTitle').focus(); return; }
  var btn=document.getElementById('saveBtn'); btn.disabled=true; btn.textContent='Savingâ€¦';
  if (editingId){
    var ok = await dbUpdate(editingId,p);
    if(ok){ toast('Item updated!'); closeModal(); await loadItems(); }
  } else {
    var r = await dbInsert(p);
    if(r){ toast('Item added!'); closeModal(); await loadItems(); }
  }
  btn.disabled=false; btn.textContent='Save Item';
}

function editItem(id){
  var item = items.find(function(i){ return String(i.id)===String(id); });
  if (!item) return;
  editingId=id;
  document.getElementById('modalTitle').textContent='Edit Item';
  selCat(item.cat||'film');
  document.getElementById('fTitle').value     = item.title     ||'';
  document.getElementById('fCreator').value   = item.creator   ||'';
  document.getElementById('fYear').value      = item.year      ||'';
  document.getElementById('fStatus').value    = item.status    ||'';
  document.getElementById('fTags').value      = item.tags      ||'';
  document.getElementById('fNotes').value     = item.notes     ||'';
  document.getElementById('fURL').value       = item.url       ||'';
  document.getElementById('fProducer').value  = item.producer  ||'';
  document.getElementById('fPublisher').value = item.publisher ||'';
  document.getElementById('fISBN').value      = item.isbn      ||'';
  document.getElementById('modalOverlay').classList.add('open');
}

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function today(){ return new Date().toISOString().slice(0,10); }

function exportJSON(){
  document.getElementById('exportWrap').classList.remove('open');
  var blob = new Blob([JSON.stringify(items,null,2)],{type:'application/json'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href=url; a.download='vault-inventory-'+today()+'.json'; a.click();
  URL.revokeObjectURL(url);
  toast('JSON backup exported!');
}

function exportExcel(){
  document.getElementById('exportWrap').classList.remove('open');
  if (!items.length){ toast('Nothing to export!'); return; }
  var wb = XLSX.utils.book_new();
  var catLabels = {film:'Films & TV',book:'Books',doc:'Documents',item:'Items'};

  // All Items sheet
  var allH = ['Title','Category','Creator','Producer','Publisher','ISBN','Year','Status','Tags','URL','Notes'];
  var allR = items.map(function(i){
    return [i.title,((CAT[i.cat]||{}).label||i.cat),i.creator,i.producer,i.publisher,i.isbn,i.year,i.status,i.tags,i.url,i.notes].map(function(v){ return v||''; });
  });
  var wsAll = XLSX.utils.aoa_to_sheet([allH].concat(allR));
  wsAll['!cols'] = allH.map(function(){ return {wch:20}; });
  XLSX.utils.book_append_sheet(wb, wsAll, 'All Items');

  // Per-category sheets
  ['film','book','doc','item'].forEach(function(cat){
    var ci = items.filter(function(i){ return i.cat===cat; });
    if (!ci.length) return;
    var h, rows;
    if (cat==='film'){
      h=['Title','Director / Creator','Producer','Year','Status','Tags','URL','Notes'];
      rows=ci.map(function(i){ return [i.title,i.creator,i.producer,i.year,i.status,i.tags,i.url,i.notes].map(function(v){return v||'';}); });
    } else if (cat==='book'){
      h=['Title','Author','Publisher','ISBN','Year','Status','Tags','URL','Notes'];
      rows=ci.map(function(i){ return [i.title,i.creator,i.publisher,i.isbn,i.year,i.status,i.tags,i.url,i.notes].map(function(v){return v||'';}); });
    } else {
      h=['Title','Category','Creator','Year','Status','Tags','URL','Notes'];
      rows=ci.map(function(i){ return [i.title,((CAT[i.cat]||{}).label||i.cat),i.creator,i.year,i.status,i.tags,i.url,i.notes].map(function(v){return v||'';}); });
    }
    var ws = XLSX.utils.aoa_to_sheet([h].concat(rows));
    ws['!cols'] = h.map(function(){ return {wch:22}; });
    XLSX.utils.book_append_sheet(wb, ws, catLabels[cat]);
  });

  XLSX.writeFile(wb, 'vault-inventory-'+today()+'.xlsx');
  toast('Excel file exported!');
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg){
  var t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); },3000);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadItems();
</script>
</body>
</html>
